<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Soroban Canvas Quiz</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100vw; height: 100vh; overflow: hidden;
      background: #b3c4e7;
    }
    #abacusRoot {
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      background: #4d79ff;
      overflow: hidden;
      z-index: 1;
    }
    .soroban {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 5px;
      width: 150%;
      height: 100%;
    }
    .rod {
      position: relative; width: 95px; height: 390px;
      background: #4d79ff;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
    }
    .rod-line {
      position: absolute; top: 0; bottom: 0; width: 3px;
      background: #6666ff; z-index: 0;
    }
    .heaven {
      display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
      height: 14%; gap: 2px; z-index: 1;
    }
    .gap-space { height: 2%; z-index: 1; }
    .earth {
      display: flex; flex-direction: column; justify-content: flex-start; align-items: center;
      height: 53%; margin-top: 3px; z-index: 1; gap: 3px;
    }
    .bar {
      position: absolute; top: 27%; width: 100%; height: 3px;
      background: #6666ff; z-index: 2;
    }
    .bead {
      width: 90px; height: 50px; margin: 0;
      background: linear-gradient(to bottom, #002db3, #002080);
      clip-path: polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%);
      box-shadow: inset -1px -1px 4px rgba(255,255,255,0.3), inset 1px 1px 4px rgba(0,0,0,0.3);
      transition: transform 0.2s; touch-action: none; z-index: 3;
    }
    .bead.active {
      background: radial-gradient(circle at 30% 30%, #ffd700, #ffa500);
      box-shadow: inset -2px -2px 5px rgba(255,255,255,0.4), inset 2px 2px 5px rgba(0,0,0,0.3);
    }
    .bead.heaven.active { transform: translateY(100%); }
    .bead.earth.active { transform: translateY(-150%); }
    @media (max-width: 768px) {
      .rod { width: 80px; height: 300px; }
      .bead { width: 75px; height: 38px; }
    }
    @media (max-width: 480px) {
      .rod { width: 70px; height: 250px; }
      .bead { width: 65px; height: 32px; }
    }
    @media screen and (orientation: portrait) {
      body::before {
        content: "Please rotate your device";
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: #b3c6ff; color: #000099; font-size: 2rem;
        display: flex; justify-content: center; align-items: center;
        z-index: 9999; text-align: center; padding: 1em;
      }
      #abacusRoot { display: none; }
    }
  </style>
</head>
<body>
  <div id="abacusRoot">
    <div class="soroban" id="sorobanBoard"></div>
  </div>
  <script>
    (() => {
      const DEAD_ZONE = 10, SWIPE_DELAY = 40, SHAKE_G = 16, HAPTIC_MS = 12;
      const $ = (s) => document.querySelector(s), $$ = (s) => [...document.querySelectorAll(s)];
      const touches = new Map();
      const board = document.getElementById('sorobanBoard');for (let i = 0; i < 7; i++) board.appendChild(createRod());

  function createRod() {
    const rod = document.createElement('div');
    rod.className = 'rod';

    const rodLine = document.createElement('div');
    rodLine.className = 'rod-line';
    rod.appendChild(rodLine);

    const heaven = document.createElement('div');
    heaven.className = 'heaven';
    const hBead = document.createElement('div');
    hBead.className = 'bead heaven';
    heaven.appendChild(hBead);

    const gap = document.createElement('div');
    gap.className = 'gap-space';

    const earth = document.createElement('div');
    earth.className = 'earth';
    for (let i = 0; i < 4; i++) {
      const eBead = document.createElement('div');
      eBead.className = 'bead earth';
      earth.appendChild(eBead);
    }

    const bar = document.createElement('div');
    bar.className = 'bar';

    rod.appendChild(heaven);
    rod.appendChild(gap);
    rod.appendChild(earth);
    rod.appendChild(bar);

    return rod;
  }

  function setBead(bead, makeActive) {
    const heaven = bead.classList.contains("heaven");
    if (heaven) {
      bead.classList.toggle("active", makeActive);
    } else {
      const earths = [...bead.parentElement.children];
      const idx = earths.indexOf(bead);
      if (makeActive) for (let i = idx; i >= 0; i--) earths[i].classList.add("active");
      else for (let i = idx; i < earths.length; i++) earths[i].classList.remove("active");
    }
    if (HAPTIC_MS) navigator.vibrate(HAPTIC_MS);
  }

  $$('.bead').forEach(bead => {
    bead.addEventListener('pointerdown', onDown);
    bead.addEventListener('pointermove', onMove);
    bead.addEventListener('pointerup', onUpCancel);
    bead.addEventListener('pointercancel', onUpCancel);
  });

  function onDown(e) {
    const bead = e.currentTarget;
    bead.setPointerCapture(e.pointerId);
    bead.classList.add("pressed");
    touches.set(e.pointerId, {
      bead,
      region: bead.classList.contains("heaven") ? "heaven" : "earth",
      startX: e.clientX, startY: e.clientY,
      lastRod: bead.closest(".rod"), mode: null, moved: false, lastCopy: performance.now()
    });
  }

  function onMove(e) {
    const t = touches.get(e.pointerId);
    if (!t) return;
    const dy = e.clientY - t.startY, dx = e.clientX - t.startX;
    if (!t.moved && Math.hypot(dx, dy) > DEAD_ZONE) t.moved = true;
    if (t.mode === null && t.moved) {
      if (t.region === "heaven") t.mode = dy > 0 ? "activate" : "deactivate";
      else t.mode = dy < 0 ? "activate" : "deactivate";
      setBead(t.bead, t.mode === "activate");
    }
    if (t.mode && performance.now() - t.lastCopy > SWIPE_DELAY) {
      const elem = document.elementFromPoint(e.clientX, e.clientY);
      const rod = elem?.closest?.(".rod");
      if (rod && rod !== t.lastRod) {
        const otherBead = rod.querySelector(`.bead.${t.region}`);
        if (otherBead) setBead(otherBead, t.mode === "activate");
        t.lastRod = rod;
        t.lastCopy = performance.now();
      }
    }
  }

  function onUpCancel(e) {
    const t = touches.get(e.pointerId);
    if (!t) return;
    t.bead.classList.remove("pressed");
    touches.delete(e.pointerId);
  }

  function clearBoard() {
    $$('.bead.active').forEach(b => b.classList.remove('active'));
  }

  if (window.DeviceMotionEvent) {
    let last = 0;
    window.addEventListener("devicemotion", ev => {
      const { x, y, z } = ev.accelerationIncludingGravity;
      const mag = Math.hypot(x, y, z);
      const now = performance.now();
      if (mag > SHAKE_G && now - last > 750) {
        clearBoard();
        last = now;
      }
    });
  }
})();

  </script>
</body>
</html>
