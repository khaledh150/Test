<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>Soroban Canvas Quiz</title>
  <style>
    /* ---------- GLOBAL LAYOUT ---------- */
    html,body{margin:0;padding:0;width:100vw;height:100vh;overflow:hidden;
      background:#b3c4e7;font-family:sans-serif}
    /* ---------- ABACUS (RIGHT) ---------- */
    #abacusRoot{position:absolute;top:0;right:0;width:100vw;height:100vh;
      display:flex;justify-content:flex-end;align-items:center;background:#4d79ff;
      overflow:hidden;z-index:1}
    .soroban{display:flex;justify-content:center;align-items:center;padding:5px;
      width:160%;height:100%}
    .rod{position:relative;width:95px;height:390px;background:#4d79ff;border-radius:5px;
      display:flex;flex-direction:column;align-items:center;justify-content:space-between}
    .rod-line{position:absolute;top:0;bottom:0;width:3px;background:#6666ff;z-index:0}
    .heaven,.earth,.gap-space,.bar{z-index:1}
    .heaven{display:flex;flex-direction:column;justify-content:flex-end;align-items:center;
      height:14%;gap:2px}
    .gap-space{height:2%}
    .earth{display:flex;flex-direction:column;justify-content:flex-start;align-items:center;
      height:53%;margin-top:3px;gap:3px}
    .bar{position:absolute;top:27%;width:100%;height:3px;background:#6666ff}
    .bead{width:90px;height:50px;background:linear-gradient(#002db3,#002080);
      clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%);
      box-shadow:inset -1px -1px 4px rgba(255,255,255,.3),
                 inset 1px 1px 4px rgba(0,0,0,.3);transition:.2s;touch-action:none;z-index:3}
    .bead.active{background:radial-gradient(circle at 30% 30%,#ffd700,#ffa500);
      box-shadow:inset -2px -2px 5px rgba(255,255,255,.4),
                 inset 2px 2px 5px rgba(0,0,0,.3)}
    .bead.heaven.active{transform:translateY(100%)}
    .bead.earth.active{transform:translateY(-150%)}
    /* ---------- QUIZ PANEL (LEFT) ---------- */
    #quizPanel{position:absolute;top:0;left:0;width:clamp(260px,22vw,380px);height:100vh;
      background:rgba(140,166,219,.95);color:#fff;z-index:2;display:flex;flex-direction:column;
      padding:1rem;display:none}
    #topBtns{display:flex;justify-content:flex-end;gap:.5rem;margin-bottom:.5rem}
    #topBtns button{background:transparent;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
    #quizContent{flex:1;display:flex;flex-direction:column;gap:1rem;overflow-y:auto}
    .question{display:flex;align-items:center;gap:.5rem}
    #qNum{background:#668cff;padding:.3rem .8rem;border-radius:.3rem;font-weight:bold}
    #qText{flex:1;display:flex;justify-content:center;align-items:center;min-height:3.4rem;
      font-size:2.6rem;font-weight:bold;text-align:center;position:relative}
    .flash-center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      font-size:2.8rem;font-weight:bold;color:#fff}
    .flash-center .qmark{color:#e53;margin-left:.18em}
    .diff-num{color:#ffd700}.diff-op{color:#ff5757}
    .full-question-text{font-size:2rem;color:#fff;font-weight:bold}
    .input-label{font-weight:bold}
    .inputArea{display:flex;gap:.5rem;align-items:center}
    #answerDisplay{flex:1;background:#fff;color:#333;text-align:right;padding:.5rem;
      border:2px solid #b993d6;border-radius:.4rem;font-size:1.2rem}
    #sendBtn{background:#668cff;border:none;color:#fff;padding:.5rem 1rem;border-radius:.4rem;
      font-size:1rem;cursor:pointer}
    #sendBtn:disabled{opacity:.6;cursor:default}
    #numpad{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem}
    #numpad button{background:#668cff;border:none;color:#fff;padding:.6rem;border-radius:.4rem;
      font-size:1.2rem;cursor:pointer}
    #quizTimer{width:100%;text-align:center;font-weight:bold;margin:16px 0 0}
    /* ---------- OVERLAY PANELS ---------- */
    #settingsPanel,#resultsPanel,#timeUpPanel,#startPanel
      {position:absolute;inset:0;background:rgba(0,0,0,.55);display:none;
       align-items:center;justify-content:center;z-index:100}
    /* settings + start card css trimmed for brevity (unchanged) */
    /* ---------- RESPONSIVE TWEAKS ---------- */
    @media(max-width:600px){
      #quizPanel{width:100vw;padding:.7rem}
      #qText,.full-question-text,.flash-center{font-size:2.1rem}
    }
  </style>
</head>
<body>
<!-- ----------------- START SCREEN ----------------- -->
<div id="startPanel">
  <div class="start-card">
    <!-- cute mascot (CSS) -->
    <div class="abacus-mascot">
      <div class="abacus-body">
        <div class="abacus-rod"></div>
        <div class="abacus-beads">
          <div class="abacus-bead"></div><div class="abacus-bead"></div>
          <div class="abacus-bead"></div><div class="abacus-bead"></div>
        </div>
        <div class="abacus-rod"></div>
      </div>
      <div class="abacus-face"></div>
    </div>
    <div class="start-title">Soroban Quiz!</div>
    <button class="start-btn" id="startQuizBtn">Start Quiz!</button>
    <button class="start-settings-btn" id="startSettingsBtn">Settings ⚙️</button>
    <div class="confetti" id="confettiBox"></div>
  </div>
</div>
<!-- ----------------- ABACUS ----------------- -->
<div id="abacusRoot"><div class="soroban" id="sorobanBoard"></div></div>
<!-- ----------------- QUIZ PANEL ----------------- -->
<div id="quizPanel">
  <div id="topBtns">
    <button id="settingsBtn">⚙️</button><button id="resetBtn">↻</button><button id="fullscreenBtn">⛶</button>
  </div>
  <div id="quizContent">
    <div class="question"><div id="qNum">Q1</div><div id="qText"></div></div>
    <div>
      <div class="input-label">Your Answer</div>
      <div class="inputArea"><div id="answerDisplay">0</div><button id="sendBtn" disabled>Send</button></div>
    </div>
    <div id="numpad"></div>
    <div id="quizTimer">Time Left: 10:00</div>
  </div>
</div>
<!-- ----------------- SETTINGS / RESULTS / TIME-UP (markup unchanged) ----------------- -->
<!-- (Settings card, Results card, Time-Up card code here, unchanged from previous) -->

<!-- ----------------- AUDIO ----------------- -->
<audio id="soundOn"  src="abacus sound effect 1.wav"></audio>
<audio id="soundOff" src="abacus sound effect 2.wav"></audio>
<audio id="tickSound" src="tick.wav"></audio>

<script>
/* ---------- CONFETTI helper ---------- */
function launchConfetti(){const box=$('#confettiBox');box.innerHTML='';
 const colors=['#ffd700','#b993d6','#4d79ff','#66e6ff','#ffb3e6','#ff7878','#c8ffb0'];
 for(let i=0;i<36;i++){const s=document.createElement('span');
  s.style.left=(Math.random()*96+2)+'%';
  s.style.background=colors[Math.random()*colors.length|0];
  s.style.animationDuration=(1.1+Math.random()*0.5)+'s';
  s.style.opacity=0.8+Math.random()*0.2;
  box.appendChild(s);} setTimeout(()=>box.innerHTML='',1600);}

/* ---------- SHORTHANDS ---------- */
const $=s=>document.querySelector(s),$$=s=>[...document.querySelectorAll(s)];
/* ---------- SOROBAN BUILD (unchanged) ---------- */
const board=$('#sorobanBoard');
for(let i=0;i<8;i++){const r=document.createElement('div');r.className='rod';
 r.innerHTML='<div class=\"rod-line\"></div><div class=\"heaven\"><div class=\"bead heaven\"></div></div><div class=\"gap-space\"></div><div class=\"earth\">'+
 '<div class=\"bead earth\"></div>'.repeat(4)+'</div><div class=\"bar\"></div>';board.appendChild(r);}
const DEAD=10,SHAKE=16,HAPT=12;let mute=false;
function clearBoard(){$$('.bead.active').forEach(b=>b.classList.remove('active'));}
$('#resetBtn').onclick=clearBoard;
function setBead(b,on){const hv=b.classList.contains('heaven'),was=b.classList.contains('active');
 if(hv)b.classList.toggle('active',on);
 else{const cs=[...b.parentElement.children],i=cs.indexOf(b);
  cs.forEach((e,idx)=>e.classList.toggle('active',on?idx<=i:idx<i));}
 if(HAPT)navigator.vibrate(HAPT);
 if(!mute){if(on&&!was)$('#soundOn').play();if(!on&&was)$('#soundOff').play();}}
$$('.bead').forEach(b=>b.addEventListener('pointerdown',e=>{
 const rg=b.classList.contains('heaven')?'heaven':'earth',sy=e.clientY;
 b.setPointerCapture(e.pointerId);
 b.onpointermove=ev=>{if(Math.abs(ev.clientY-sy)>DEAD){setBead(b,rg==='heaven'?ev.clientY-sy>0:ev.clientY-sy<0);b.onpointermove=null;}};
 b.onpointerup=b.onpointercancel=()=>{b.onpointermove=null;b.releasePointerCapture(e.pointerId);};
}));
if(window.DeviceMotionEvent){let last=0;
 window.addEventListener('devicemotion',ev=>{
  const {x,y,z}=ev.accelerationIncludingGravity,mag=Math.hypot(x,y,z),now=performance.now();
  if(mag>SHAKE&&now-last>750){clearBoard();last=now;}
});}

/* ---------- SETTINGS & STATE ---------- */
let numQuestions=10,numNumbers=4,flashSpeed=1,flashEnabled=true,timerMinutes=10;
let QUESTIONS=[],ci=0,answers=[],inp='',locked=true,timerInt,flashTimer,timeLeft=600;
const qN=$('#qNum'),qT=$('#qText'),ansD=$('#answerDisplay'),sendB=$('#sendBtn'),timer=$('#quizTimer');

/* ---------- RANDOM QUESTION GENERATOR WITH NEW RULES ---------- */
function randomChapter1(){
 const arr=[];
 while(arr.length<numQuestions){
   const nums=Array.from({length:numNumbers},()=>Math.floor(Math.random()*5)+1);
   if(nums[0]===5)continue;
   let bad=false;
   // no two numbers total 5
   for(let i=0;i<nums.length&&!bad;i++)for(let j=i+1;j<nums.length;j++){if(nums[i]+nums[j]===5){bad=true;break}}
   if(bad)continue;

   let res=nums[0],steps=[String(nums[0])],stage=[res];
   for(let i=1;i<numNumbers;i++){
     let op=Math.random()<.5?'+':'-';
     if(op==='-'&&res===5&&nums[i]!==5){bad=true;break;}
     let next=op==='+'?res+nums[i]:res-nums[i];
     if(next<0||next>9||next===5){bad=true;break;}
     steps.push(`${op} ${nums[i]}`);res=next;stage.push(res);
     // extra rules
     if(i===1&&nums[0]===4&&steps[1].startsWith('-')&&!(nums[1]>=1&&nums[1]<=4)){bad=true;}
     if(i===1&&nums[0]===4&&steps[1].startsWith('+')&&nums[1]!==5){bad=true;}
     if(i===1&&res<4&&!(res<4||nums[2]===5)){} // handled later with final check
   }
   if(bad||stage.includes(5))continue;
   if(stage[1]<4 && !(res<4||nums[2]===5))continue;
   if(stage[1]===0 && !steps[2].startsWith('+'))continue;
   if(stage[1]===4 && nums[2]!==5)continue;
   if(nums[0]===5 && steps[2]&&steps[2].startsWith('-') && !(nums[1]>nums[2]))continue;
   arr.push({q:steps.join(' '),a:String(res)});
 }
 return arr;
}

/* ---------- FLASH TOKEN HELPER ---------- */
function tokens(q){let a=q.split(/([+-])/).map(s=>s.trim()).filter(Boolean),t=[{f:a[0]}];
 for(let i=1;i<a.length;i+=2)t.push({op:a[i],v:a[i+1]});return t;}
function flash(q,cb){
 if(flashTimer)clearTimeout(flashTimer);let t=tokens(q),i=0;locked=true;sendB.disabled=true;
 qT.innerHTML='';const c=document.createElement('div');c.className='flash-center';qT.appendChild(c);
 const show=()=>{
  if(i>=t.length)return;
  let html='';
  if(t[i].f)html=t[i].f;else{
    let h=i>1&&t[i-1].op===t[i].op&&t[i-1].v===t[i].v;
    html=`<span class=\"${h?'diff-op':''}\">${t[i].op}</span> <span class=\"${h?'diff-num':''}\">${t[i].v}</span>${i===t.length-1?'<span class=qmark>?</span>':''}`;
  }
  c.innerHTML=html;if(!mute){$('#tickSound').currentTime=0;$('#tickSound').play();}
  flashTimer=setTimeout(()=>{
    if(i===t.length-1){
      qT.innerHTML=`<span class=\"full-question-text\">${q} <span class=qmark>?</span></span>`;
      locked=false;sendB.disabled=inp==='';
      cb&&cb();
    }else{ i++;show(); }
  },flashSpeed*1000);
 };
 show();
}

/* ---------- QUIZ CONTROL ---------- */
function loadQ(){
 const q=QUESTIONS[ci];qN.textContent='Q'+(ci+1);inp='';ansD.textContent='0';locked=true;sendB.disabled=true;
 flashEnabled?flash(q.q): (qT.innerHTML=`<span class=full-question-text>${q.q} <span class=qmark>?</span></span>`,locked=false);}
function updTimer(){const m=String(Math.floor(timeLeft/60)).padStart(2,'0'),
 s=String(timeLeft%60).padStart(2,'0');timer.textContent=`Time Left: ${m}:${s}`;}
function startQuiz(){
 QUESTIONS=randomChapter1();ci=0;answers=[];timeLeft=timerMinutes*60;updTimer();
 $('#quizPanel').style.display='flex';loadQ();
 timerInt&&clearInterval(timerInt);timerInt=setInterval(()=>{timeLeft--;updTimer();if(timeLeft<=0){clearInterval(timerInt);showTimeUp();}},1000);}
function append(d){if(locked)return;if(d==='C')inp='';else if(d==='BACK')inp=inp.slice(0,-1);else inp+=d;
 ansD.textContent=inp||'0';sendB.disabled=inp==='';}
function submit(){if(locked||inp==='')return;locked=true;
 answers.push({q:QUESTIONS[ci].q,c:QUESTIONS[ci].a,u:inp});sendB.disabled=true;
 if(ci<QUESTIONS.length-1){setTimeout(()=>{ci++;loadQ();},350);}else showResults();}
sendB.onclick=submit;ansD.onclick=submit;
['0','1','2','3','4','5','6','7','8','9','C','BACK'].forEach((d,i)=>$('#numpad').children[i].onclick=()=>append(d));

/* ---------- RESULTS / TIME-UP ---------- (functions unchanged for brevity) */
/* ---------- SETTINGS PANEL ---------- (handlers unchanged for brevity) */
/* ---------- START PANEL ---------- */
$('#startQuizBtn').onclick=()=>{launchConfetti();$('#startPanel').style.display='none';startQuiz();}
$('#startSettingsBtn').onclick=()=>{$('#settingsPanel').style.display='flex';}
/* ---------- FULLSCREEN / MUTE ---------- */
$('#fullscreenBtn').onclick=()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();}
$('#muteSound').onchange=e=>mute=e.target.checked;
/* ---------- INIT ---------- */
$('#startPanel').style.display='flex';
</script>
</body>
</html>
