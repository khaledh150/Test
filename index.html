<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Soroban Quiz</title>
  <link href="https://fonts.googleapis.com/css?family=Nunito:400,700&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden;
      font-family: 'Nunito', Arial, sans-serif;
      background: linear-gradient(135deg, #d8e9fa 0%, #e8f2ff 70%, #e5f0ff 100%);
      min-height: 100vh; min-width: 100vw;
      transition: background .3s;
    }
    #abacusRoot {
      position: absolute; top: 0; right: 0; width: 100vw; height: 100vh;
      display: flex; justify-content: flex-end; align-items: center;
      background: none;
      overflow: hidden; z-index: 1;
    }
    .soroban {
      display: flex; justify-content: center; align-items: center;
      padding: 5px; width: 160%; height: 100%;
      background: none !important;
    }
@media (max-width: 400px) {
  #abacusRoot {
    transform: translateX(528px);  /* Change 28px to what you like */
  }
    .rod {
      position: relative; width: 95px; height: 390px;
      background: rgba(255,255,255,0.58);
      border-radius: 28px; box-shadow: 0 3px 30px #b993d633, 0 0 0 0 #fff0;
      display: flex; flex-direction: column; align-items: center; justify-content: space-between;
    }
    .rod-line { position: absolute; top: 0; bottom: 0; width: 3px; background: #b4d7ff; z-index: 0;}
    .heaven, .earth, .gap-space, .bar { z-index: 1; }
    .heaven { display: flex; flex-direction: column; justify-content: flex-end; align-items: center; height: 13%; gap: 3px;}
    .gap-space { height: 2%; }
    .earth { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; height: 52.5%; margin-top: 3px; gap: 3px;}
    .bar { position: absolute; top: 27%; width: 100%; height: 3px; background: #b4d7ff;}
    /* Beads */
    .bead {
      width: 90px; height: 50px; margin: 0;
      background: linear-gradient(to bottom, #285ca3 80%, #4676b7 100%);
      border-radius: 18px;
      clip-path: polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%);
      box-shadow: 0 5px 15px #b993d655, inset 0 2px 7px #e1eeffbb;
      transition: background .13s, box-shadow .13s, transform .15s, filter .15s;
      z-index: 3; opacity: 1;
    }
    .bead.dragged {
  background: linear-gradient(to bottom, #fff8c7 70%, #ffe99a 100%) !important;
  filter: brightness(1.06) drop-shadow(0 0 11px #fff7aa77);
}
.bead.active:not(.dragged) {
  background: radial-gradient(circle at 40% 38%, #ffd700 67%, #ffef8b 100%) !important;
  box-shadow: 0 2px 32px #ffd9ff77, 0 0 0 0 #fff0;
  filter: drop-shadow(0 0 11px #ffe066aa);
  border-top: 3px solid #fff4b0;
  border-bottom: 3px solid #ffe066;
}
    .bead.heaven.active { transform: translateY(100%) scale(1.07);}
    .bead.earth.active { transform: translateY(-150%) scale(1.07);}
    /* Quiz panel card */
    #quizPanel {
      position: absolute; top: 0; left: 0;
      width: clamp(265px,23vw,390px); height: 100vh;
      background: linear-gradient(150deg, #fef5fa 65%, #f6f3fa 100%, #e6eaff 0%);
      color: #444; z-index: 2; display: flex; flex-direction: column; padding: 1rem 1rem 1rem 1rem;
      border-radius: 2.5rem 3.2rem 3.2rem 2.5rem;
      box-shadow: 0 10px 48px #b993d628;
      border: 2.6px solid #e7c9eb;
      transition: background .3s, box-shadow .2s;
      overflow-x: visible;
    }
    @media (max-width: 900px) and (max-height: 500px) {
      #quizPanel {
        width: 100vw; min-width: 0; max-width: 100vw; padding: .22rem; border-radius: 0 2.6rem 2.6rem 0;
        left: 0; right: auto;
      }
      #quizContent { gap: 0.12rem; }
      .results-footer { flex-direction: row; }
    }
    @media (max-width: 600px) {
      #quizPanel {
        width: 100vw; max-width: 100vw; min-width: 0; padding: .6rem; border-radius: 0 2.2rem 2.2rem 0;
        left: 0; right: auto;
      }
      .results-card { width: 98vw; }
      #startPanel .start-card { width: 99vw; }
      .soroban { width: 100vw;}
      .rod { width: 38vw; min-width: 60px;}
      .results-footer { flex-direction: row; }
    }
    @media (max-width: 380px) {
      #quizPanel { padding: .1rem;}
      .settings-card, .results-card { padding: .5rem;}
    }
    #quizContent { flex: 1; display: flex; flex-direction: column; gap: 0.0rem; overflow-y: auto;}
    .question { display: flex; align-items: flex-end; justify-content: left; gap: 0.0rem; }
    #qNum {
      background: #668cff;
      border-radius: 1.5rem;
      font-weight: bold; color: #fff; font-size: 2.25rem;
      min-width: 3.6rem; min-height: 2.5rem;
      display: flex; align-items: center; justify-content: center;
      text-align: center;
      margin-right: 0.11rem;
      box-shadow: 0 2px 8px #b993d622;
      letter-spacing: .03em;
      position: relative;
      top: 1px;
    }
    /* Question flash tokens & full question text positioning above answer */
    #questionFlashArea {
      width: 100%; display: flex; justify-content: center; align-items: center;
      position: relative;
      min-height: 3.7rem;
      margin-bottom: 0.10rem;
      margin-top: 0.10rem;
    }
    .flash-center {
      width: 100%;
      position: relative;
      top: 1px;
      display: flex; align-items: center; justify-content: center;
      z-index: 2; font-size: 2.95rem; font-weight: 900; color: #4d79ff;
      font-family: 'Nunito', Arial, sans-serif;
      filter: drop-shadow(0 1px 3px #b993d6b2);
      animation: fadein .6s cubic-bezier(.71,1.31,.54,.96);
    }
    .flash-center .qmark { color: #fd90d7; font-size: 1em; font-weight: bold; margin-left: 0.18em; vertical-align: middle;}
    .full-question-text {
      font-size: 2.22rem;
      color: #4d79ff; font-weight: bold;
      letter-spacing: 0.06em; text-align: center; width: 100%; opacity: 1;
      filter: drop-shadow(0 1px 2px #b993d6b1);
      display: flex; align-items: center; justify-content: center;
      min-height: 3.2rem; margin-left: 0.0rem;
      top: 1px; position: relative;
    }
    .input-label { font-weight: bold; font-size: 1.05rem; color: #9066ff;}
    .inputArea { display: flex; gap: 0.20rem; align-items: center; }
    #answerDisplay {
      flex: 1;
      background: #fff; color: #4d79ff;
      text-align: right; padding: 0.24rem 0.8rem;
      border: 2.1px solid #fd90d7;
      border-radius: 0.87rem;
      font-size: 1.19rem; font-weight: 700;
      user-select: none;
      margin-top: 0.13rem; margin-bottom: 0.03rem;
      box-shadow: 0 4px 16px #b993d63c;
      outline: none;
      min-width: 2rem;
      max-width: 99%;
      height: 1.6rem;
      animation: fadein .19s;
    }
    #numpad {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 0.2rem; margin-top: .2rem;
    }
    #numpad button,
    .btn, .start-btn, .start-settings-btn, .settings-actions button,
    #sendBtn, .results-footer button, .results-footer .btn, #fullscreenBtn, #fullscreenBtnResults, #fullscreenBtnTimeUp, #resetBtn, #settingsBtn {
      background: #b4d7ff !important;
      color: #3e366b !important;
      font-size: 1.13rem !important;
      border-radius: 2.2rem !important;
      box-shadow: 0 3px 14px #bdd6ff14 !important;
      font-weight: 700 !important;
      outline: none !important;
      border: none !important;
      padding: 0.44rem 1.4em !important;
      margin: 0 0.1em !important;
      transition: background .13s, color .13s, transform .13s cubic-bezier(.81,1.28,.61,.95) !important;
      min-width: 2.7em;
      min-height: 2.25em;
      display: inline-flex; align-items: center; justify-content: center;
    }
    #numpad button:active,
    .btn:active, .start-btn:active, .start-settings-btn:active, .settings-actions button:active,
    #sendBtn:active, .results-footer button:active, .results-footer .btn:active, #fullscreenBtn:active, #fullscreenBtnResults:active, #fullscreenBtnTimeUp:active, #resetBtn:active, #settingsBtn:active {
      background: #fd90d7 !important;
      color: #fff !important;
      transform: scale(1.09) !important;
    }
    #sendBtn, .settings-actions button {
      min-width: 5.5em !important;
      font-size: 1.18rem !important;
      border-radius: 2.2rem !important;
    }
    .start-btn {
      background: linear-gradient(90deg, #ae90fd 0%, #d492ff 100%) !important;
      color: #fff !important;
      border-radius: 2.6rem !important;
      font-size: 1.45rem !important;
      font-weight: 800 !important;
      padding: 1.2rem 2.7rem !important;
      min-width: 9.5em !important;
      min-height: 2.7em;
      margin-top: 0.95em;
      box-shadow: 0 8px 32px #b993d6bb !important;
      transition: background .15s;
    }
    .start-btn:active {
      background: #fd90d7 !important;
      color: #fff !important;
    }
    .start-settings-btn {
      margin-top: 0.49rem;
      font-size: 1.14rem !important;
      color: #668cff !important;
      background: #b4d7ff !important;
      border: none !important;
      border-radius: 2.2rem !important;
      font-weight: 600 !important;
      min-width: 6.4em !important;
      min-height: 2.25em;
      transition: opacity .14s;
    }
    .start-settings-btn:active { background: #fd90d7 !important; color: #fff !important; }
    /* Timer: centered below numpad */
    #quizTimer {
      text-align: center;
      font-weight: bold; margin: 5px 0 0 0;
      align-self: center;
      background: #b4d7ff;
      color: #fff;
      border-radius: 1.0rem;
      font-size: 1.21rem;
      box-shadow: 0 4px 14px #b993d66c;
      letter-spacing: .04em;
      min-height: 1.0rem;
      height: 1.5rem;
      padding: 0.02rem 0.23rem;
      position: relative;
      left: 0;
      top: 0.00em;
      width: fit-content;
      display: block;
      border: none;
    }
    #topBtns {
      display: flex; justify-content: flex-end; align-items: center; margin-bottom: 0.00rem; gap: 1.0rem;
      width: 100%; padding: 0; box-sizing: border-box;
    }
    #topBtns button {
      width: 1.55em !important;
      height: 1.55em !important;
      min-width: 1.55em !important;
      min-height: 1.55em !important;
      font-size: 1.37rem !important;
      border-radius: 2.2rem !important;
      padding: 0 !important;
      box-shadow: 0 3px 14px #bdd6ff22 !important;
      margin: 0 !important;
      text-align: center !important;
      display: inline-flex; align-items: center; justify-content: center;
    }
    /* Panels (start/settings/results/timeup) background */
    #startPanel, #settingsPanel, #resultsPanel, #timeUpPanel {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(225,228,255,0.82);
      display: none; align-items: center; justify-content: center; z-index: 100;
      animation: fadein-soft .51s cubic-bezier(.67,1.71,.42,.89);
      transition: opacity .34s cubic-bezier(.67,1.51,.51,1.1);
      will-change: opacity, transform;
    }
    .settings-card, .results-card, .timeup-card, .start-card {
      background: #fff;
      border-radius: 2.7rem;
      width: 91vw; max-width: 410px;
      padding: 2.3rem 1.2rem 2.4rem 1.2rem;
      display: flex; flex-direction: column; align-items: center; gap: 1.19rem;
      box-shadow: 0 10px 46px #b993d6b3;
      border: 2.5px solid #b4d7ff;
      animation: fadein-soft .56s cubic-bezier(.51,1.77,.62,.91);
    }
    .results-card { padding: 02rem 0.2rem; gap: 0.2rem; max-width: 725px;}
    .timeup-card { width: 90vw; max-width: 360px; text-align: top-center; }
    .results-footer { display: flex; justify-content: center; gap: 0.2rem; width: 100%; flex-wrap: wrap; margin-top: 0.0rem;}
    .results-footer button, .results-footer .btn { margin-bottom: 0 !important; }
    /* Settings panel: flex, label left, control right, round toggles/inputs */
    .settings-card label {
      display: flex; flex-direction: row; justify-content: space-between; align-items: center;
      width: 100%; font-size: 1.15rem; color: #4d79ff; margin-bottom: 0.23em;
    }
    .settings-card input[type="number"], .settings-card select {
      font-family: 'Nunito', Arial, sans-serif;
      border-radius: 1.5rem;
      border: 2px solid #b4d7ff;
      padding: 0.32em 1em; font-size: 1.15rem;
      color: #4d79ff; background: #e9f3ff;
      font-weight: 700; width: 4.6em; box-shadow: 0 2px 8px #bdd6ff22;
      transition: border .17s;
      outline: none;
    }
    .settings-card input[type="number"]:focus,
    .settings-card select:focus {
      border-color: #fd90d7;
      background: #fff6fa;
      color: #fd90d7;
    }
    /* Cute round toggle switches */
    .settings-card input[type="checkbox"] {
      appearance: none; width: 2.2em; height: 2.2em; border-radius: 50%;
      border: 2px solid #b4d7ff; background: #e9f3ff; position: relative;
      vertical-align: middle; transition: border .12s, background .13s;
      cursor: pointer; box-shadow: 0 2px 8px #bdd6ff22;
      outline: none;
    }
    .settings-card input[type="checkbox"]:checked {
      background: #fd90d7; border-color: #fd90d7;
    }
    .settings-actions {
      display: flex; flex-direction: row; justify-content: center; gap: 1.19rem;
      width: 100%; margin-top: 0.7em;
    }
.rain-sparkle {
  pointer-events: none;
  position: fixed;
  left: 0; top: 0; width: 100vw; height: 100vh; z-index: 4999;
  overflow: hidden;
  animation: fadein .11s;
}
.rain-sparkle span {
  position: absolute; pointer-events: none;
  font-size: 2.4rem;
  opacity: 0.77;
  animation: sparkle-rain 1.95s cubic-bezier(.61,1.47,.72,.91) forwards;
  filter: drop-shadow(0 1px 11px #ffd7ef77);
  user-select: none;
  will-change: transform, opacity;
}
@keyframes sparkle-rain {
  0% { opacity: 0.3; transform: translateY(-30px) scale(.95) rotate(-6deg);}
  75% { opacity: 1; }
  100% { opacity: 0; transform: translateY(99vh) scale(1.2) rotate(11deg);}
}
    /* Panel mascot and confetti */
    .mascot-bounce-in { animation: mascotpop .71s cubic-bezier(.51,1.77,.62,.91) 1;}
    @keyframes mascotpop { 0% { transform: translateY(-60px) scale(0.78);} 60% { transform: translateY(16px) scale(1.09);} 85% { transform: translateY(-8px) scale(.93);} 100% { transform: translateY(0) scale(1);} }
    .abacus-mascot { width: 125px; height: 150px; margin-bottom: 0.2rem; position:relative; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 12; filter: drop-shadow(0 2px 12px #b993d6a1); background: none;}
    .mascot-face { position: absolute; left: 50%; top: 52%; transform: translate(-50%,0); width: 45px; height: 38px; background: #ffe680; border-radius: 50% 50% 58% 60%; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 18px #fff8, 0 0 0 3px #fff3; border: 2.2px solid #ffd70088;}
    .mascot-face .eyes { display: flex; flex-direction: row; align-items: center; margin-top: 13px; margin-left: 6px;}
    .mascot-face .eye { width: 7px; height: 7px; background: #333; border-radius: 50%; margin-right: 6px; margin-left: 3px; box-shadow: 9px 0 0 0 #333;}
    .mascot-face .smile { position: absolute; left: 49%; top: 68%; transform: translate(-50%,-50%); width: 23px; height: 11px; border-bottom: 3.3px solid #ff7e7e; border-radius: 0 0 19px 19px; background: none; z-index: 1;}
    .mascot-face .cheek { position: absolute; width: 8px; height: 4px; border-radius: 50%; background: #fd90d7bb; top: 80%; left: 18%; }
    .mascot-face .cheek.right { left: 66%;}
    .abacus-body { width: 100%; height: 90px; position:relative; background: #b4d7ff; border-radius: 30px; border: 3px solid #4761b8; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 2px 10px #b993d644;}
    .abacus-rod { width: 90px; height: 7px; background: #fff; border-radius: 6px; margin: 13px auto 0 auto; position:relative; box-shadow: 0 1px 4px #fff5;}
    .abacus-beads { display: flex; flex-direction: row; gap: 13px; margin-top: -12px; margin-bottom: -5px; justify-content: center;}
    .abacus-bead { width: 21px; height: 21px; background: #ffd700; border-radius: 50%; border: 2px solid #ffe05b; margin-top: 5px; margin-bottom: 2px; box-shadow: 0 2px 8px #fff8, 0 0 0 2px #fff8; animation: beadbounce 1s infinite alternate cubic-bezier(.71,1.64,.51,.88);}
    .abacus-bead:nth-child(2) { animation-delay: .17s;}
    .abacus-bead:nth-child(3) { animation-delay: .31s;}
    .abacus-bead:nth-child(4) { animation-delay: .46s;}
    @keyframes beadbounce { from { transform: translateY(0);} to { transform: translateY(-10px);} }
    .start-title { font-size: 2.5rem; font-weight: 700; color: #4d79ff; text-shadow: 0 2px 0 #fff6, 0 0 12px #fff8; letter-spacing: 0.09em; text-align: center; margin:0; font-family: 'Nunito', Arial, sans-serif;}
    .confetti { pointer-events:none; position:absolute; left:0; top:0; width:100%; height:100%; z-index:12; overflow:visible;}
    .confetti span { position:absolute; width:13px; height:13px; border-radius:50%; opacity:0.76; animation: confetti-fall 1.4s linear forwards; will-change: transform;}
    @keyframes confetti-fall { from { transform:translateY(-40px);} to { transform:translateY(370px);} }
    .shake { animation: shake .21s cubic-bezier(.62,1.75,.52,.91);}
    @keyframes shake { 0%,100%{transform:translateX(0);} 10%,30%,50%,70%,90%{transform:translateX(-8px);} 20%,40%,60%,80%{transform:translateX(8px);} }
    @keyframes fadein { from { opacity: 0;} to { opacity: 1;} }
    #resultsTitle { color: #fd90d7 !important; font-size: 2.1rem; font-weight: 800; text-align: center; }
    .sad-emoji { font-size: 2.6rem; filter: drop-shadow(0 2px 10px #aaa5); margin-bottom: 0.5em; }
    .sad-text { color: #668cff; font-weight: 700; font-size: 1.34rem; margin: .3em 0; }
    .encouragement { color: #fd90d7; font-size: 1.12rem; margin: .6em 0; }
    /* Make scrollbars cute/round on panels */
    ::-webkit-scrollbar {
      width: 8px; border-radius: 9px; background: #e9f3ff;
    }
    ::-webkit-scrollbar-thumb {
      background: #b4d7ff; border-radius: 9px;
    }
@media (max-width: 600px) {
  .results-card {
    max-height: 70vh;   /* Adjust this value as you wish */
    height: auto;       /* Let the content determine height, but limit it */
    padding: 1.1rem 0.5rem !important; /* Reduce padding for smaller screens */
    overflow-y: auto;   /* Enable scroll if content is tall */
  }
  #resultsPanel {
    align-items: flex-start; /* Push the panel towards the top for easier reach */
    padding-top: 0.7em;
  }
}

  </style>
</head>
<body>
  <!-- Start Panel -->
  <div id="startPanel">
    <div class="start-card">
      <div class="abacus-mascot mascot-bounce-in" id="mainMascot">
        <div class="abacus-body">
          <div class="abacus-rod"></div>
          <div class="abacus-beads">
            <div class="abacus-bead"></div>
            <div class="abacus-bead"></div>
            <div class="abacus-bead"></div>
            <div class="abacus-bead"></div>
          </div>
          <div class="abacus-rod"></div>
        </div>
        <div class="mascot-face">
          <div class="eyes"><div class="eye"></div></div>
          <div class="smile"></div>
          <div class="cheek"></div>
          <div class="cheek right"></div>
        </div>
      </div>
      <div class="start-title">Soroban Quiz!</div>
      <button class="start-btn" id="startQuizBtn">Start Quiz!</button>
      <button class="start-settings-btn" id="startSettingsBtn">Settings ⚙️</button>
      <div class="confetti" id="confettiBox"></div>
    </div>
  </div>
  <div id="abacusRoot"><div class="soroban" id="sorobanBoard"></div></div>
  <div id="quizPanel" style="display:none;">
    <div id="topBtns"><button id="settingsBtn">⚙️</button><button id="resetBtn">↻</button><button id="fullscreenBtn">⛶</button></div>
    <div id="quizContent">
      <div class="question"><div id="qNum">Q1</div></div>
      <div id="questionFlashArea"></div>
      <div>
        <div class="input-label">Your Answer</div>
        <div class="inputArea">
          <div id="answerDisplay">0</div>
          <button id="sendBtn" disabled>Send</button>
        </div>
      </div>
      <div id="numpad"></div>
      <div id="quizTimer">Time Left: 10:00</div>
    </div>
  </div>
  <div id="settingsPanel">
    <div class="settings-card">
      <label>Questions per set:
        <input type="number" id="numQuestions" min="1" max="50" value="20">
      </label>
      <label>Flash speed (sec):
        <select id="flashSpeedSec">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </label>
      <label>Flash tokens:
        <input type="checkbox" id="flashToggle" checked>
      </label>
      <label>Timer (min):
        <select id="timerSelect"></select>
      </label>
      <label>Mute:
        <input type="checkbox" id="muteSound">
      </label>
      <div class="settings-actions">
        <button id="cancelSettings">Cancel</button>
        <button id="saveSettings">Save</button>
      </div>
    </div>
  </div>
  <div id="resultsPanel"><div class="results-card">
    <div class="abacus-mascot" id="resultMascot" style="display:none;">
      <div class="abacus-body">
        <div class="abacus-rod"></div>
        <div class="abacus-beads">
          <div class="abacus-bead"></div>
          <div class="abacus-bead"></div>
          <div class="abacus-bead"></div>
          <div class="abacus-bead"></div>
        </div>
        <div class="abacus-rod"></div>
      </div>
      <div class="mascot-face">
        <div class="eyes"><div class="eye"></div></div>
        <div class="smile"></div>
        <div class="cheek"></div>
        <div class="cheek right"></div>
      </div>
    </div>
    <h2 id="resultsTitle">Results</h2>
    <div class="results-row" id="resultsList" style="max-height:40vh;overflow-y:auto;width:100%"></div>
    <div id="resultScore"></div>
    <div id="resultsConfetti"></div>
    <div class="results-footer"><button id="tryAgainBtn">↺ Try Again</button><button id="fullscreenBtnResults">⛶</button></div>
  </div></div>
  <div id="timeUpPanel"><div class="timeup-card">
    <div style="font-size:2.2rem;color:#fd90d7;font-weight:800;margin-bottom:.6em;">Time's Up!</div>
    <div class="results-footer"><button id="tryAgainTimeUpBtn">↺ Try Again</button><button id="fullscreenBtnTimeUp">⛶</button></div>
  </div></div>
  <div id="rainSparkle" class="rain-sparkle" style="display:none"></div>
  <audio id="soundOn" src="abacus sound effect 1.wav"></audio>
  <audio id="soundOff" src="abacus sound effect 2.wav"></audio>
  <audio id="tickSound" src="tick.wav"></audio>
  <audio id="goSound" src="go.wav"></audio>
  <audio id="correctSound" src="correctanswersound.mp3"></audio>
  <audio id="wrongSound" src="WrongAnswer.wav"></audio>
  <audio id="applauseSound" src="applause.mp3"></audio>
  <audio id="losingHorn" src="losing-horn.mp3"></audio>
  <script>
    // Utility selectors
    const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
    // Confetti fun
    function launchConfetti(node) {
      node = node || $('#confettiBox');
      node.innerHTML = '';
      const colors = ['#ffd700','#b993d6','#4d79ff','#66e6ff','#ffb3e6','#fd90d7','#c8ffb0'];
      for(let i=0;i<36;i++) {
        const el = document.createElement('span');
        el.style.left = (Math.random()*96+2)+'%';
        el.style.background = colors[Math.floor(Math.random()*colors.length)];
        el.style.animationDuration = (1.1+Math.random()*0.5)+'s';
        el.style.opacity = 0.82 + Math.random()*0.18;
        el.style.transform = `rotate(${Math.random()*360}deg)`;
        node.appendChild(el);
      }
      setTimeout(()=>{ node.innerHTML=''; }, 1600);
    }
    // RAIN sparkle/stars/emoji (like rain, not freeze!)
    function rainSparkleBurst(style="happy") {
      const rain = $('#rainSparkle');
      rain.innerHTML = '';
      rain.style.display = '';
      let stars;
      if(style==="sad") {
        stars = ['💫','💪','💪','💪','💪','💪','💪','👏'];
      } else {
        stars = ['✨','⭐','🌟','✦','✺','✧','🟡','💫','🎊','🎉','🦄','🍭','🎈','👏','😺'];
      }
      const N = 34 + Math.floor(Math.random()*8);
      for(let i=0;i<N;i++) {
        const el = document.createElement('span');
        el.innerText = stars[Math.floor(Math.random()*stars.length)];
        el.style.left = (Math.random()*97)+'vw';
        el.style.top = (-40 + Math.random()*12)+'px';
        el.style.fontSize = (1.6 + Math.random()*2.1)+'rem';
        el.style.opacity = 0.47 + Math.random()*0.53;
        el.style.animationDelay = (Math.random()*0.5)+'s';
        rain.appendChild(el);
      }
      setTimeout(()=>{ rain.style.display='none'; }, 2300);
    }
    // Soroban abacus logic (unchanged, only color via CSS)
    const DEAD_ZONE=2, SHAKE_G=20, HAPTIC_MS=12; let mute=false;
    const board=$('#sorobanBoard');
    function createRod(){
      const r=document.createElement('div');
      r.className='rod';
      r.innerHTML="<div class='rod-line'></div><div class='heaven'><div class='bead heaven'></div></div><div class='gap-space'></div><div class='earth'>"+'<div class=\"bead earth\"></div>'.repeat(4)+"</div><div class='bar'></div>";
      return r;
    }
    for(let i=0;i<8;i++) board.appendChild(createRod());
    function clearBoard(){
      $$('.bead.active').forEach(b=>b.classList.remove('active'));
    }
    $('#resetBtn').onclick=()=>{
      clearBoard();
      shakeEffect();
    };
    function setBead(b,active){
      const hv=b.classList.contains('heaven'),was=b.classList.contains('active');
      if(hv) b.classList.toggle('active',active);
      else{
        const cs=[...b.parentElement.children],idx=cs.indexOf(b);
        cs.forEach((e,i)=>e.classList.toggle('active',active?i<=idx:i<idx));
      }
      if(HAPTIC_MS)navigator.vibrate(HAPTIC_MS);
      if(!mute){
        if(active&&!was) $('#soundOn').play();
        if(!active&&was) $('#soundOff').play();
      }
    }
    $$('.bead').forEach(b=>{
      b.addEventListener('pointerdown',e=>{
        b.classList.add('dragged');
        const rg=b.classList.contains('heaven')?'heaven':'earth',sy=e.clientY;
        b.setPointerCapture(e.pointerId);
        b.onpointermove=ev=>{
          let dy=ev.clientY-sy;
          if(Math.abs(dy)>DEAD_ZONE){setBead(b,rg==='heaven'?dy>0:dy<0);b.onpointermove=null;}
        };
        b.onpointerup=b.onpointercancel=()=>{
          b.onpointermove=null;
          b.classList.remove('dragged');
          b.releasePointerCapture(e.pointerId);
        }
      });
    });
    // Shake to reset soroban + app shake effect
    function shakeEffect(){
      const abacusRoot=$('#abacusRoot');
      abacusRoot.classList.remove('shake');
      void abacusRoot.offsetWidth;
      abacusRoot.classList.add('shake');
      setTimeout(()=>abacusRoot.classList.remove('shake'),220);
    }
    if(window.DeviceMotionEvent){
      let last=0;
      window.addEventListener('devicemotion',e=>{
        const{x,y,z}=e.accelerationIncludingGravity,mag=Math.hypot(x,y,z),now=performance.now();
        if(mag>SHAKE_G&&now-last>800){
          clearBoard(); shakeEffect();
          last=now;
        }
      });
    }
    function randomChapter1(numQuestions = 20) {
  const out = [];
  const usedQuestions = new Set();

  while (out.length < numQuestions) {
    const A = r15(), B = r15(), C = r15(), op1 = rOp();
    if (A === 5 && op1 === '-' && B !== 5) continue;     // 5 − B rule
    if (A === 5 && op1 === '+' && B === 5) continue;     // forbid 5 + 5
    if (A === 4 && op1 === '-' && !(B >= 1 && B <= 4)) continue;
    if (A === 4 && op1 === '+' && B !== 5) continue;
    if (A <= 4 && Math.abs(evalOp(A, op1, B)) > 4) continue;
    const AB = evalOp(A, op1, B);
    if (AB < 0 || AB > 9) continue;
    if (AB === 5) continue;
    let op2 = (AB === 0) ? '+' : rOp();
    if (AB === 4 && C !== 5) continue;
    if (A === 5 && op2 === '+' && !(AB + C >= 5 && AB + C <= 9)) continue;
    if (A === 5 && op2 === '-' && !(B > C)) continue;
    const D = evalOp(AB, op2, C);
    if (D < 0 || D > 9 || D === 5) continue;
    if (AB < 4 && !(D < 4 || C === 5)) continue;
    if (A + B === 5 || A + C === 5 || B + C === 5) continue;

    // Format the question as a string for duplicate checking
    const questionStr = `${A} ${op1} ${B} ${op2} ${C}`;

    // Only add if NOT already used
    if (!usedQuestions.has(questionStr)) {
      out.push({ q: questionStr, a: D.toString() });
      usedQuestions.add(questionStr);
    }
    // If duplicate, do nothing and let loop try again
  }

  return out;

  function r15()  { return Math.floor(Math.random() * 5) + 1; }
  function rOp()  { return Math.random() < 0.5 ? '+' : '-'; }
  function evalOp(x,o,y){ return o === '+' ? x + y : x - y; }
}
    // Settings & state
    let numQuestions = 20, flashSpeed = 1, flashEnabled = true, timerMinutes = 10;
    let QUESTIONS = [], currentIndex = 0, answers = [], currentInput = '', inputLocked = false, timerInterval, timeLeft = 600;
    let flashTokenTimer = null;
    const qNumEl = $('#qNum'), answerEl = $('#answerDisplay'), sendBtnEl = $('#sendBtn');
    const timerEl = $('#quizTimer'), padContainer = $('#numpad');
    const settingsBtn = $('#settingsBtn'), settingsPanel = $('#settingsPanel');
    const flashSpeedSec = $('#flashSpeedSec'), flashToggle = $('#flashToggle');
    const numQuestionsInput = $('#numQuestions');
    const timerSelect = $('#timerSelect'), muteSoundInput = $('#muteSound');
    const questionFlashArea = $('#questionFlashArea');
    for(let i=1;i<=10;i++) {
      let opt = document.createElement('option');
      opt.value = i; opt.textContent = i;
      if(i===10) opt.selected = true;
      timerSelect.appendChild(opt);
    }
    padContainer.innerHTML='';
    ['0','1','2','3','4','5','6','7','8','9','C','BACK'].forEach(d=>{
      const b=document.createElement('button');
      b.innerHTML = d==='BACK' ? '⌫' : d;
      b.onclick=()=>appendDigit(d);
      padContainer.appendChild(b);
    });
    // Start Panel logic
    function showStartPanel() {
      $('#startPanel').style.display='flex';
      $('#quizPanel').style.display='none';
      $('#resultsPanel').style.display='none';
      $('#timeUpPanel').style.display='none';
      $('#mainMascot').classList.add('mascot-bounce-in');
    }
    function hideStartPanel() {
      $('#startPanel').style.display='none';
      $('#mainMascot').classList.remove('mascot-bounce-in');
    }
    // Ready-Set-Go flash sequence
    function showReadySetGo(cb) {
      questionFlashArea.innerHTML = '';
      const seq = ['Ready','Set','Go!'];
      let i = 0;
      function flashNext() {
        qNumEl.style.visibility = 'hidden';
        questionFlashArea.innerHTML = `<div class="flash-center">${seq[i]}</div>`;
        if(i === 2){
          $('#goSound').currentTime=0; $('#goSound').play();
        }
        if(i < 2) {
          setTimeout(()=>{ i++; flashNext(); }, 650);
        } else {
          setTimeout(()=>{
            questionFlashArea.innerHTML = '';
            qNumEl.style.visibility = '';
            cb();
          }, 650);
        }
      }
      flashNext();
    }
    $('#startQuizBtn').onclick = () => {
      hideStartPanel();
      setTimeout(() => launchConfetti($('#confettiBox')), 130);
      startQuiz(true);
    };
    $('#startSettingsBtn').onclick = () => { settingsPanel.style.display='flex'; };
    // Settings panel setup
    let updatingQuizNow = false;
    settingsBtn.onclick=()=>{
      settingsPanel.style.display='flex';
      numQuestionsInput.value=numQuestions;
      flashSpeedSec.value=flashSpeed;
      flashToggle.checked=flashEnabled;
      timerSelect.value=timerMinutes;
      muteSoundInput.checked=mute;
      updatingQuizNow = ($('#quizPanel').style.display==='flex');
    };
    $('#cancelSettings').onclick=()=>{settingsPanel.style.display='none';};
    $('#saveSettings').onclick=()=>{
      const prevNumQ = numQuestions, prevTimer = timerMinutes;
      numQuestions = Math.max(1, Math.min(50, Number(numQuestionsInput.value)));
      flashSpeed = Math.max(1, Math.min(5, Number(flashSpeedSec.value)));
      flashEnabled = !!flashToggle.checked;
      timerMinutes = Math.max(1, Math.min(10, Number(timerSelect.value)));
      mute = muteSoundInput.checked;
      settingsPanel.style.display='none';
      if(updatingQuizNow && (numQuestions!==prevNumQ || timerMinutes!==prevTimer)){
        startQuiz(true);
      }
    };
    // ---- Tokenize logic for flash
    function parseQuestionToTokens(q) {
      let arr = q.split(/([+-])/).map(s=>s.trim()).filter(Boolean);
      let tokens = [];
      tokens.push({type: 'first', val: arr[0]});
      for(let i=1;i<arr.length;i+=2) {
        tokens.push({type:'op', op:arr[i], val:arr[i+1]});
      }
      return tokens;
    }
    function flashQuestionTokens(questionString, cb) {
      if (flashTokenTimer) clearTimeout(flashTokenTimer);
      let tokens = parseQuestionToTokens(questionString);
      let idx = 0;
      questionFlashArea.innerHTML = '';
      let centerDiv = document.createElement('div');
      centerDiv.className = 'flash-center';
      centerDiv.style.fontSize = "2.99rem";
      questionFlashArea.appendChild(centerDiv);
      inputLocked=true; sendBtnEl.disabled=true;
      function showNext() {
        centerDiv.innerHTML = '';
        if (idx < tokens.length) {
          let html = '';
          if(tokens[idx].type === 'first') {
            html = tokens[idx].val;
          } else {
            html = `<span style="font-size:2.99rem">${tokens[idx].op}</span> <span style="font-size:2.99rem">${tokens[idx].val}</span>`;
            if(idx === tokens.length-1) {
              html += `<span class="qmark" style="font-size:2.99rem">?</span>`;
            }
          }
          centerDiv.innerHTML = html;
          if(!mute){ $('#tickSound').currentTime=0; $('#tickSound').play();}
          if(idx === tokens.length-1) {
            flashTokenTimer = setTimeout(()=>{
              questionFlashArea.innerHTML = `<span class="full-question-text">${questionString.replace(/\s*$/, '')} <span class="qmark">?</span></span>`;
              inputLocked=false; sendBtnEl.disabled=(currentInput==='');
              cb&&cb();
            }, flashSpeed*1000);
            sendBtnEl.disabled=false;
          } else {
            flashTokenTimer = setTimeout(()=>{
              idx++;
              showNext();
            }, flashSpeed*1000);
          }
        }
      }
      showNext();
    }
    // ---- Quiz logic ----
    function appendDigit(d) {
      if (inputLocked) return;
      if (d === 'C') currentInput = '';
      else if (d === 'BACK') currentInput = currentInput.slice(0, -1);
      else currentInput += d;
      answerEl.textContent = currentInput || '0';
      sendBtnEl.disabled = (currentInput.length === 0);
    }
    function loadQuestion() {
      const q = QUESTIONS[currentIndex];
      qNumEl.textContent = 'Q'+(currentIndex + 1);
      qNumEl.style.fontSize = "2.19rem";
      answerEl.textContent = '0';
      currentInput = ''; inputLocked=true; sendBtnEl.disabled=true;
      if (flashEnabled) {
        flashQuestionTokens(q.q, ()=>{
          inputLocked=false;
          sendBtnEl.disabled=(currentInput==='');
        });
      } else {
        questionFlashArea.innerHTML = `<span class="full-question-text">${q.q} <span class="qmark">?</span></span>`;
        inputLocked=false;
        sendBtnEl.disabled=(currentInput==='');
      }
      qNumEl.style.visibility = '';
    }
    function updateTimer() {
      let m = String(Math.floor(timeLeft / 60)).padStart(2, '0'),
          s = String(timeLeft % 60).padStart(2, '0');
      timerEl.textContent = "Time Left: " + m + ":" + s;
    }
    function submitAnswer() {
      if (inputLocked || currentInput.length===0) return;
      inputLocked=true;
      let correct = (currentInput === QUESTIONS[currentIndex].a);
      answers.push({ question: QUESTIONS[currentIndex].q, correct: QUESTIONS[currentIndex].a, user: currentInput });
      sendBtnEl.disabled = true;
      clearBoard();
      if(!mute){
        if(correct){
          $('#correctSound').currentTime=0; $('#correctSound').play();
        } else {
          $('#wrongSound').currentTime=0; $('#wrongSound').play();
        }
      }
      if(currentIndex < QUESTIONS.length - 1) {
        setTimeout(()=>{
          currentIndex++; loadQuestion();
        }, 370);
      } else {
        showResults();
      }
    }
    function startQuiz(showReadySetGoFlag) {
      if (flashTokenTimer) clearTimeout(flashTokenTimer);
      currentIndex=0; answers=[]; currentInput=''; inputLocked=true;
      timeLeft = timerMinutes * 60;
      $('#quizPanel').style.display='flex';
      $('#resultsPanel').style.display='none';
      $('#timeUpPanel').style.display='none';
      $('#resultMascot').style.display='none';
      QUESTIONS = randomChapter1(numQuestions);
      updateTimer();
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        timeLeft--; updateTimer();
        if(timeLeft<=0){
          clearInterval(timerInterval);
          showTimeUp();
        }
      },1000);
      if(showReadySetGoFlag){
        showReadySetGo(loadQuestion);
      } else {
        loadQuestion();
      }
    }
    sendBtnEl.onclick=submitAnswer;
    answerEl.onclick=submitAnswer;
    // --- Results panel
    function showResults() {
      $('#quizPanel').style.display='none';
      $('#resultsPanel').style.display='flex';
      $('#timeUpPanel').style.display='none';
      clearInterval(timerInterval);
      const rl = $('#resultsList'), rs = $('#resultScore');
      rl.innerHTML=''; let sc=0;
      answers.forEach((a,i)=>{
        let cor = a.user===a.correct;
        if (cor) sc++;
        let di = document.createElement('div');
        di.className='result-item';
        di.innerHTML=`<div class='question-text'>Q${i+1}: ${a.question}</div><div class='your-answer'><span class='mark'>${cor?'✔️':'❌'}</span><span>Your: ${a.user}</span></div>${!cor?`<div class='correct-answer'>Correct: ${a.correct}</div>`:''}`;
        rl.appendChild(di);
     });
rs.textContent=`You scored ${sc}/${answers.length}`;
let resultsConfetti = $('#resultsConfetti');
resultsConfetti.innerHTML = '';
$('#rainSparkle').style.display='none';
let pct = sc / answers.length;
if (sc === answers.length || pct >= 0.7) {
  $('#resultMascot').style.display = '';
  $('#resultsTitle').innerHTML = `✨Results <span class="sparkle-emoji">✨</span>`;
  let spark = document.createElement('div');
  spark.className = 'sparkle-text';
  spark.innerHTML = `🎉🌟Perfect! All correct! <span class="sparkle-emoji">🌟🎉</span>`;
  resultsConfetti.appendChild(spark);
  rainSparkleBurst("happy");
  if(!mute){ $('#applauseSound').currentTime=0; $('#applauseSound').play(); }
} else if (pct < 0.5) {
  $('#resultsTitle').innerHTML = `<span class="sad-emoji"></span> <span style="color:#fd90d7">Results</span>`;
  let sad = document.createElement('div');
  sad.className = 'sad-text';
  
  resultsConfetti.appendChild(sad);

  let enc = document.createElement('div');
  enc.className = 'encouragement';
  enc.innerText = "You'll get better with practice. Give it another go!";
  resultsConfetti.appendChild(enc);

  // Insert the GIF
  let gif = document.createElement('img');
  gif.src = 'stay-strong-fist-pump.gif';
  gif.alt = 'Stay Strong!';
  gif.style.width = '110px';
  gif.style.display = 'block';
  gif.style.margin = '1.1em auto 0 auto';
  gif.style.borderRadius = '1.2em';
  resultsConfetti.appendChild(gif);

  rainSparkleBurst("sad");
  if(!mute){ $('#losingHorn').currentTime=0; $('#losingHorn').play(); }
} else {
  $('#resultsTitle').innerText = "Results";
  let happyEmojis = [
    '🎊','👏','🥳','🏆','🌸','👏','🎉','🍀','💎','🎈','🍭','🥳','👍','👌','😊','🙌','🎁','😉','🎉','💝','🏅','🚀','😁','🥰','🎊'
  ];
  let em = document.createElement('div');
  em.className = 'emoji-pop';
  em.innerText = happyEmojis[Math.floor(Math.random()*happyEmojis.length)];
  resultsConfetti.appendChild(em);
  rainSparkleBurst("happy");
}
    }
    // ... [rest of JS unchanged]
    // Try Again and fullscreen etc (unchanged)
    $('#tryAgainBtn').onclick = ()=>startQuiz(true);
    $('#fullscreenBtnResults').onclick = () => {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    };
    $('#tryAgainTimeUpBtn').onclick = ()=>startQuiz(true);
    $('#fullscreenBtnTimeUp').onclick = () => {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    };
    $('#fullscreenBtn').onclick = () => {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    };
    muteSoundInput.onchange = () => { mute = muteSoundInput.checked; };
    showStartPanel();
  </script>
</body>
</html>
